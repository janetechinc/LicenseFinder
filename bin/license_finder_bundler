#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler'
require 'json'

def log_debug(msg)
  warn(msg.to_s) if ENV['DEBUG'] == 'on'
end

raise 'BUNDLE_GEMFILE required' unless ENV.key?('BUNDLE_GEMFILE')

ignored_groups = ARGV.dup

log_debug "Gemfile: #{ENV['BUNDLE_GEMFILE']}"

specs = []
groups = []

Bundler.ui.silence do
  definition = Bundler.definition
  groups = definition.groups.reject { |group| ignored_groups.include?(group.to_s) }

  specs = if groups.empty?
            definition.specs
          else
            definition.specs_for(groups)
          end

  specs = specs.map(&:to_yaml)
rescue Bundler::GemfileNotFound => err
  log_debug "Gemfile not found: #{err.message}"
  exit(1)
rescue => err
  log_debug "Unknown Error: #{err.message}"
  exit(2)
end

output = {
  'groups' => groups,
  'specs' => specs
}

puts output.to_json

exit(0)
