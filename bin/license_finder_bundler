#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler'
require 'json'

raise 'BUNDLE_GEMFILE required' unless ENV.key?('BUNDLE_GEMFILE')

ignored_groups = ARGV.dup

warn "Gemfile: #{ENV['BUNDLE_GEMFILE']}" if ENV['DEBUG'] == 'on'

specs = []
groups = []

Bundler.ui.silence do
  definition = Bundler.definition
  groups = definition.groups.reject { |group| ignored_groups.include?(group.to_s) }

  specs = if groups.empty?
            definition.specs
          else
            definition.specs_for(groups)
          end

  specs = specs.map(&:to_yaml)
end

output = {
  'groups' => groups,
  'specs' => specs
}

puts output.to_json

exit(0)
